<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Feed tipo Twitter (Gatinhos)</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Form fixo no topo */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11, 18, 32, 0.95);
      border-bottom: 1px solid var(--border);
      padding: 16px;
    }

    .container { max-width: 760px; margin: 0 auto; }

    .form-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    textarea {
      width: 100%;
      min-height: 90px;
      resize: vertical;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
    }

    .btn:hover { background: rgba(255,255,255,0.10); }
    .hint { color: var(--muted); font-size: 12px; }

    main { padding: 16px; }

    /* LISTA DE POSTAGENS */
    #feed {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 12px;
    }

    /* Cada item (post) */
    .post {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .post-header {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .user {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }

    .avatar {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 1px solid var(--border);
      object-fit: cover;
      flex: 0 0 auto;
    }

    .user-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .username {
      font-weight: 800;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
    }

    .date { color: var(--muted); font-size: 12px; }

    .post-text {
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .cat-img {
      width: 100%;
      max-height: 420px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }

    .post-actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    .like-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor: pointer;
      font-weight: 800;
      color: var(--text);
    }

    .like-btn:hover { background: rgba(255,255,255,0.10); }
    .likes { color: var(--muted); font-weight: 700; }
  </style>
</head>
<body>

  <header>
    <div class="container">
      <div class="form-card">
        <div class="row">
          <div>
            <div style="font-weight: 900; font-size: 16px;">Postar</div>
            <div class="hint">Ao postar, uma imagem aleatória de gatinho será buscada na API.</div>
          </div>
          <div class="hint" id="status"></div>
        </div>

        <form id="postForm">
          <textarea id="postText" placeholder="O que está acontecendo?"></textarea>
          <div class="row">
            <span class="hint">Posts vazios não são permitidos.</span>
            <button class="btn" type="submit" id="btnPostar">Postar</button>
          </div>
        </form>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <!-- ✅ LISTA DE POSTS -->
      <ul id="feed"></ul>
    </div>
  </main>

  <script>
    // Usuário fixo (pode trocar)
    const USUARIO_FIXO = {
      nome: "meu_usuario",
      avatar: "https://i.pravatar.cc/150?img=12"
    };

    // ✅ Feed como array de objetos: data, usuario, avatar, texto, imagem, likes
    const feed = [];

    const form = document.getElementById("postForm");
    const postText = document.getElementById("postText");
    const feedEl = document.getElementById("feed");
    const statusEl = document.getElementById("status");
    const btnPostar = document.getElementById("btnPostar");

    function setStatus(msg) { statusEl.textContent = msg || ""; }

    function formatarData(date) {
      return date.toLocaleString("pt-BR", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    async function buscarImagemGatinho() {
      const resp = await fetch("https://api.thecatapi.com/v1/images/search");
      if (!resp.ok) throw new Error("Falha ao buscar gatinho");
      const data = await resp.json();
      return data?.[0]?.url || "";
    }

    function escaparHTML(str) {
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    // ✅ Renderiza a LISTA de posts, do mais recente pro mais antigo (como está no array)
    function renderizarFeed() {
      feedEl.innerHTML = "";

      if (feed.length === 0) {
        const li = document.createElement("li");
        li.className = "post";
        li.innerHTML = `<div class="hint">Nenhuma postagem ainda. Faça a primeira!</div>`;
        feedEl.appendChild(li);
        return;
      }

      feed.forEach((post, index) => {
        const li = document.createElement("li");
        li.className = "post";

        li.innerHTML = `
          <div class="post-header">
            <div class="user">
              <img class="avatar" src="${post.avatar}" alt="Avatar de ${escaparHTML(post.usuario)}">
              <div class="user-meta">
                <div class="username">@${escaparHTML(post.usuario)}</div>
                <div class="date">${escaparHTML(post.data)}</div>
              </div>
            </div>
          </div>

          <div class="post-text">${escaparHTML(post.texto)}</div>

          ${
            post.imagem
              ? `<img class="cat-img" src="${post.imagem}" alt="Gatinho fofo">`
              : `<div class="hint">Não foi possível carregar a imagem do gatinho.</div>`
          }

          <div class="post-actions">
            <button class="like-btn" type="button" data-index="${index}">
              ❤️ Curtir <span class="likes">(${post.likes})</span>
            </button>
          </div>
        `;

        feedEl.appendChild(li);
      });
    }

    // ✅ Curtir: incrementa likes do post correto e re-renderiza
    feedEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".like-btn");
      if (!btn) return;

      const index = Number(btn.dataset.index);
      if (Number.isNaN(index) || !feed[index]) return;

      feed[index].likes += 1;
      renderizarFeed();
    });

    // ✅ Postar: busca imagem, cria objeto e adiciona no começo (mais recente)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const texto = postText.value.trim();
      if (!texto) {
        setStatus("Digite algo antes de postar.");
        return;
      }

      try {
        setStatus("Postando (buscando gatinho)...");
        btnPostar.disabled = true;

        let imagemUrl = "";
        try {
          imagemUrl = await buscarImagemGatinho();
        } catch (err) {
          imagemUrl = ""; // fallback
        }

        const novoPost = {
          data: formatarData(new Date()),
          usuario: USUARIO_FIXO.nome,
          avatar: USUARIO_FIXO.avatar,
          texto: texto,
          imagem: imagemUrl,
          likes: 0
        };

        // ✅ mais recente -> mais antigo
        feed.unshift(novoPost);

        postText.value = "";
        postText.focus();
        renderizarFeed();
        setStatus("Post feito!");
      } finally {
        btnPostar.disabled = false;
        setTimeout(() => setStatus(""), 1200);
      }
    });

    renderizarFeed();
  </script>
</body>
</html>
